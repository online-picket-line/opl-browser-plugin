name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.0.1, etc.

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  build-and-release:
    name: Download Artifacts and Create Release
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate icons
        run: node generate-icons.js

      - name: Build extension packages
        run: bash package.sh

      - name: Download build artifacts from CI
        uses: actions/download-artifact@v4
        with:
          name: all-browser-packages
          path: dist/
        continue-on-error: true

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify manifest version matches tag
        run: |
          MANIFEST_VERSION=$(jq -r '.version' manifest.json)
          TAG_VERSION="${{ steps.get_version.outputs.version }}"

          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: manifest.json version ($MANIFEST_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi

          echo "âœ… Version check passed: $MANIFEST_VERSION"

      - name: Create checksums
        run: |
          cd dist
          sha256sum *.zip > checksums.txt
          cat checksums.txt

      - name: Create release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Online Picket Line Browser Extension v${{ steps.get_version.outputs.version }}

          ### Store-Ready Packages

          Download the appropriate package for your target browser store:

          - **Chrome Web Store**: `opl-chrome-edge.zip`
          - **Firefox Add-ons**: `opl-firefox.zip`
          - **Opera Add-ons**: `opl-opera.zip`
          - **Safari App Store**: `opl-safari.zip` (requires Xcode conversion)

          ### Installation Instructions

          #### For Store Submission
          1. Download the appropriate `.zip` file above
          2. Go to your browser's developer dashboard
          3. Upload the `.zip` file directly (no need to extract)
          4. Fill in store listing information
          5. Submit for review

          See [STORE_UPDATE_GUIDE.md][guide] for submission instructions.

          [guide]: https://github.com/online-picket-line/opl-browser-plugin/blob/main/STORE_UPDATE_GUIDE.md

          #### For Local Testing

          **Chrome/Edge/Brave/Opera:**
          ```bash
          unzip opl-chrome-edge.zip -d opl-unpacked
          # Load unpacked: chrome://extensions â†’ Developer mode â†’ Load unpacked â†’ select opl-unpacked
          ```

          **Firefox:**
          ```bash
          # Temporary: about:debugging â†’ Load Temporary Add-on â†’ select opl-firefox.zip
          ```

          ### Package Checksums

          ```
          EOF
          cat dist/checksums.txt >> release_notes.md
          echo '```' >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/opl-chrome-edge.zip
            dist/opl-firefox.zip
            dist/opl-opera.zip
            dist/opl-safari.zip
            dist/checksums.txt
          draft: false
          prerelease: false

      - name: Upload artifacts to workflow
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-v${{ steps.get_version.outputs.version }}
          path: |
            dist/*.zip
            dist/checksums.txt
          retention-days: 365
          compression-level: 0

      - name: Display release summary
        run: |
          echo "### Release v${{ steps.get_version.outputs.version }} Created ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Packages Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser Store | Package | Size | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|---------|------|--------|" >> $GITHUB_STEP_SUMMARY

          cd dist
          for file in *.zip; do
            size=$(du -h "$file" | cut -f1)
            checksum=$(sha256sum "$file" | cut -d' ' -f1 | cut -c1-12)
            store="${file#opl-}"
            store="${store%.zip}"
            echo "| $store | \`$file\` | $size | \`${checksum}...\` |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          REPO="${{ github.repository }}"
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "1. Download packages from the [Releases page](https://github.com/$REPO/releases/tag/v$VERSION)" \
            >> $GITHUB_STEP_SUMMARY
          echo "2. Submit to browser stores:" >> $GITHUB_STEP_SUMMARY
          echo "   - [Chrome Web Store Dashboard](https://chrome.google.com/webstore/devconsole)" \
            >> $GITHUB_STEP_SUMMARY
          echo "   - [Firefox Add-ons Developer Hub](https://addons.mozilla.org/developers/)" \
            >> $GITHUB_STEP_SUMMARY
          echo "   - [Opera Add-ons Developer](https://addons.opera.com/developer/)" \
            >> $GITHUB_STEP_SUMMARY
          echo "3. See [STORE_UPDATE_GUIDE.md](https://github.com/$REPO/blob/main/STORE_UPDATE_GUIDE.md) for details" \
            >> $GITHUB_STEP_SUMMARY
