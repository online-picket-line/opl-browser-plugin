name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Super linter needs the full git history
        fetch-depth: 0
        
    - name: Super Linter
      uses: github/super-linter/slim@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Only validate specific file types for browser extension project
        VALIDATE_CSS: true
        VALIDATE_HTML: true
        VALIDATE_JAVASCRIPT_ES: true
        VALIDATE_JSON: true
        VALIDATE_MARKDOWN: true
        VALIDATE_YAML: true
        # Configure linter behavior
        SUPPRESS_POSSUM: true
        FILTER_REGEX_EXCLUDE: '(node_modules/|coverage/|dist/|\.zip$)'

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run unit tests
      run: npm test
      
    - name: Generate coverage report
      run: npm run test:coverage
      
    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  build:
    name: Build Extensions
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate icons
      run: node generate-icons.js
      
    - name: Build extension packages
      run: bash package.sh
      
    - name: Upload Chrome Web Store package
      uses: actions/upload-artifact@v4
      with:
        name: chrome-webstore-package
        path: dist/opl-chrome-edge.zip
        retention-days: 90
        
    - name: Upload Firefox Add-ons package
      uses: actions/upload-artifact@v4
      with:
        name: firefox-addons-package
        path: dist/opl-firefox.zip
        retention-days: 90
        
    - name: Upload Opera Add-ons package
      uses: actions/upload-artifact@v4
      with:
        name: opera-addons-package
        path: dist/opl-opera.zip
        retention-days: 90
        
    - name: Upload Safari package
      uses: actions/upload-artifact@v4
      with:
        name: safari-package
        path: dist/opl-safari.zip
        retention-days: 90
        
    - name: Upload all packages (combined)
      uses: actions/upload-artifact@v4
      with:
        name: all-browser-packages
        path: dist/*.zip
        retention-days: 90
        
    - name: Display build summary
      run: |
        echo "### Build Summary ðŸ“¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Built store-ready extension packages:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Browser | Package | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|------|" >> $GITHUB_STEP_SUMMARY
        for file in dist/*.zip; do
          name=$(basename "$file" .zip)
          size=$(du -h "$file" | cut -f1)
          echo "| ${name#opl-} | \`$(basename "$file")\` | $size |" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Ready for Store Submission âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Chrome Web Store**: Download \`chrome-webstore-package\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Firefox Add-ons**: Download \`firefox-addons-package\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Opera Add-ons**: Download \`opera-addons-package\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Safari App Store**: Download \`safari-package\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "See [STORE_UPDATE_GUIDE.md](STORE_UPDATE_GUIDE.md) for submission instructions." >> $GITHUB_STEP_SUMMARY
