name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run unit tests
      run: npm test
      
    - name: Generate coverage report
      run: npm run test:coverage
      
    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  build:
    name: Build Plugins
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate icons
      run: node generate-icons.js
      
    - name: Build plugins
      run: bash package.sh
      
    - name: Prepare artifacts (extract zip contents)
      run: |
        mkdir -p artifacts
        unzip -q dist/opl-chrome-edge.zip -d artifacts/opl-chrome-edge
        unzip -q dist/opl-firefox.zip -d artifacts/opl-firefox
        unzip -q dist/opl-opera.zip -d artifacts/opl-opera
        unzip -q dist/opl-safari.zip -d artifacts/opl-safari
      
    - name: Upload Chrome/Edge plugin
      uses: actions/upload-artifact@v4
      with:
        name: opl-chrome-edge
        path: artifacts/opl-chrome-edge/
        retention-days: 90
        
    - name: Upload Firefox plugin
      uses: actions/upload-artifact@v4
      with:
        name: opl-firefox
        path: artifacts/opl-firefox/
        retention-days: 90
        
    - name: Upload Opera plugin
      uses: actions/upload-artifact@v4
      with:
        name: opl-opera
        path: artifacts/opl-opera/
        retention-days: 90
        
    - name: Upload Safari plugin
      uses: actions/upload-artifact@v4
      with:
        name: opl-safari
        path: artifacts/opl-safari/
        retention-days: 90
        
    - name: Display build summary
      run: |
        echo "### Build Summary ðŸ“¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Built extensions:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -lh dist/ >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
