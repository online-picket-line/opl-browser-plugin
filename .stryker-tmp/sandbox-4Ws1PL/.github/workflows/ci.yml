name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        config: |
          name: "Security Analysis"
          queries:
            - uses: security-and-quality
            - uses: security-extended
            
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"
        
    - name: Run npm audit for dependency vulnerabilities
      run: |
        echo "### NPM Security Audit ðŸ”" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        npm audit --audit-level=moderate --json > audit-results.json || echo "Vulnerabilities found"
        
        # Parse and display results
        if [ -f audit-results.json ]; then
          VULNERABILITIES=$(cat audit-results.json | jq '.metadata.vulnerabilities // 0')
          if [ "$VULNERABILITIES" != "0" ] && [ "$VULNERABILITIES" != "null" ]; then
            echo "âš ï¸ Found $VULNERABILITIES vulnerabilities in dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY || true
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No vulnerabilities found in dependencies" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
    - name: Secret Detection with TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        extra_args: --debug --only-verified --no-verification
        
    - name: ESLint Security Rules
      run: |
        # Install security-focused ESLint plugins
        npm install --no-save eslint @eslint/js eslint-plugin-security eslint-plugin-no-unsanitized
        
        # Create security-focused ESLint config
        cat > .eslint-security.js << 'EOF'
        import js from '@eslint/js';
        import security from 'eslint-plugin-security';
        import noUnsanitized from 'eslint-plugin-no-unsanitized';
        
        export default [
          js.configs.recommended,
          {
            plugins: {
              security,
              'no-unsanitized': noUnsanitized
            },
            rules: {
              'security/detect-object-injection': 'error',
              'security/detect-non-literal-regexp': 'error',
              'security/detect-unsafe-regex': 'error',
              'security/detect-buffer-noassert': 'error',
              'security/detect-child-process': 'error',
              'security/detect-disable-mustache-escape': 'error',
              'security/detect-eval-with-expression': 'error',
              'security/detect-new-buffer': 'error',
              'security/detect-no-csrf-before-method-override': 'error',
              'security/detect-pseudoRandomBytes': 'error',
              'no-unsanitized/method': 'error',
              'no-unsanitized/property': 'error'
            },
            languageOptions: {
              globals: {
                chrome: 'readonly',
                browser: 'readonly',
                console: 'readonly',
                document: 'readonly',
                window: 'readonly',
                fetch: 'readonly',
                atob: 'readonly',
                btoa: 'readonly'
              }
            }
          }
        ];
        EOF
        
        # Run security linting
        echo "### Security Linting Results ðŸ”’" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if npx eslint --config .eslint-security.js "*.js" "tests/*.js"; then
          echo "âœ… No security issues found in JavaScript code" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Security issues detected - see job logs for details" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Check for hardcoded secrets patterns
      run: |
        echo "### Secret Pattern Detection ðŸ•µï¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Define patterns to search for
        PATTERNS=(
          "(?i)(password|passwd|pwd)\s*[=:]\s*['\"][^'\"\s]{8,}"
          "(?i)(secret|token)\s*[=:]\s*['\"][^'\"\s]{16,}"
          "(?i)(key|api_key|apikey)\s*[=:]\s*['\"][^'\"\s]{16,}"
          "['\"][A-Za-z0-9+/]{40,}['\"]"  # Base64 patterns
          "['\"][A-Fa-f0-9]{32,}['\"]"     # Hex patterns
        )
        
        FOUND_SECRETS=false
        
        for pattern in "${PATTERNS[@]}"; do
          if grep -rE "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" --exclude="ci.yml"; then
            FOUND_SECRETS=true
          fi
        done
        
        if [ "$FOUND_SECRETS" = true ]; then
          echo "âš ï¸ Potential secrets detected - review findings above" >> $GITHUB_STEP_SUMMARY
          echo "Note: Base64 encoded API key in api-service.js is expected (obfuscated, not secret)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… No suspicious secret patterns found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Security Summary
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Security Scan Complete ðŸ›¡ï¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scans Performed:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… CodeQL semantic security analysis" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… NPM dependency vulnerability scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TruffleHog secret detection" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ESLint security rules" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Pattern-based secret detection" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Review the Security tab for detailed CodeQL findings." >> $GITHUB_STEP_SUMMARY

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: security
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Super linter needs the full git history
        fetch-depth: 0
        
    - name: Super Linter
      uses: super-linter/super-linter/slim@v8.3.2
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Only validate specific file types for browser extension project
        VALIDATE_CSS: true
        VALIDATE_HTML: true
        VALIDATE_JAVASCRIPT_ES: true
        VALIDATE_JSON: true
        VALIDATE_MARKDOWN: true
        VALIDATE_YAML: true
        # Configure linter behavior
        SUPPRESS_POSSUM: true
        LINTER_RULES_PATH: .github/linters
        # Filter out unwanted directories and files
        FILTER_REGEX_EXCLUDE: '(node_modules|coverage|\.git)'

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [security, lint]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run unit tests
      run: npm test
      
    - name: Generate coverage report
      run: npm run test:coverage
      
    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  build:
    name: Build Extensions
    runs-on: ubuntu-latest
    needs: [security, lint, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate icons
      run: node generate-icons.js
      
    - name: Build extension packages
      run: bash package.sh
      
    - name: Upload Chrome Web Store package
      uses: actions/upload-artifact@v4
      with:
        name: chrome-webstore-package
        path: dist/opl-chrome-edge.zip
        retention-days: 90
        
    - name: Upload Firefox Add-ons package
      uses: actions/upload-artifact@v4
      with:
        name: firefox-addons-package
        path: dist/opl-firefox.zip
        retention-days: 90
        
    - name: Upload Opera Add-ons package
      uses: actions/upload-artifact@v4
      with:
        name: opera-addons-package
        path: dist/opl-opera.zip
        retention-days: 90
        
    - name: Upload Safari package
      uses: actions/upload-artifact@v4
      with:
        name: safari-package
        path: dist/opl-safari.zip
        retention-days: 90
        
    - name: Upload all packages (combined)
      uses: actions/upload-artifact@v4
      with:
        name: all-browser-packages
        path: dist/*.zip
        retention-days: 90
        
    - name: Display build summary
      run: |
        echo "### Build Summary ðŸ“¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Built store-ready extension packages:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Browser | Package | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|------|" >> $GITHUB_STEP_SUMMARY
        for file in dist/*.zip; do
          name=$(basename "$file" .zip)
          size=$(du -h "$file" | cut -f1)
          echo "| ${name#opl-} | \`$(basename "$file")\` | $size |" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Ready for Store Submission âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Chrome Web Store**: Download \`chrome-webstore-package\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Firefox Add-ons**: Download \`firefox-addons-package\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Opera Add-ons**: Download \`opera-addons-package\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Safari App Store**: Download \`safari-package\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "See [STORE_UPDATE_GUIDE.md](STORE_UPDATE_GUIDE.md) for submission instructions." >> $GITHUB_STEP_SUMMARY
